#include "value.hh"
#include "csts.hh"

using namespace rd_utils;
using namespace rd_utils::utils;

namespace kv_store::common {

    Value::Value (uint32_t len)
        : _data (nullptr)
        , _length (0)
    {
        if (MAX_VALUE_SIZE < MemorySize::B (len)) {
            throw std::runtime_error ("Value is too big");
        }

        uint8_t * mem = reinterpret_cast <uint8_t*> (malloc (len));
        if (mem == nullptr) {
            throw std::runtime_error ("Out of memory");
        }

        this-> _data = mem;
        this-> _length = len;
    }

    /*!
     * ====================================================================================================
     * ====================================================================================================
     * ====================================          GETTERS          =====================================
     * ====================================================================================================
     * ====================================================================================================
     */

    const uint8_t* Value::data () const {
        return this-> _data;
    }

    uint32_t Value::len () const {
        return this-> _length;
    }

    uint8_t* Value::data () {
        return this-> _data;
    }

    /*!
     * ====================================================================================================
     * ====================================================================================================
     * ======================================          MISC          ======================================
     * ====================================================================================================
     * ====================================================================================================
     */

    std::ostream& operator<< (std::ostream & s, const Value & k) {
        if (k.len () == 0) {
            s << "#null";
        } else {
            s << "[";
            for (uint32_t i = 0 ; i < k.len () ; i++) {
                s << k.data ()[i];
            }
            s << "]";
        }

        return s;
    }

    /*!
     * ====================================================================================================
     * ====================================================================================================
     * ===================================          DISPOSING          ====================================
     * ====================================================================================================
     * ====================================================================================================
     */

    Value::~Value () {
        if (this-> _data != nullptr) {
            free (this-> _data);
            this-> _data = nullptr;
            this-> _length = 0;
        }
    }

}
